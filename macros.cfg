########################################
## macros configuration 
## https://github.com/KevinOConnor/klipper/blob/master/config/sample-macros.cfg
########################################


[gcode_macro START_PRINT]
default_parameter_BED_TEMP: 60
default_parameter_EXTRUDER_TEMP: 200
gcode:
    ; Ender 3 Custom Start G-code
    M140 S{material_bed_temperature_layer_0} ; Set Heat Bed temperature
    M190 S{material_bed_temperature_layer_0} ; Wait for Heat Bed temperature
    M104 S160; start warming extruder to 160
    G28 ; Home all axes
    M420 S ; BL Touch on Start
    G92 E0 ; Reset Extruder
    M104 S{material_print_temperature_layer_0} ; Set Extruder temperature
    G1 X0.1 Y20 Z0.3 F5000.0 ; Move to start position
    M109 S{material_print_temperature_layer_0} ; Wait for Extruder temperature
    ; G1 Z2.0 F3000 ; Move Z Axis up little to prevent scratching of Heat Bed
    G1 X0.1 Y200.0 Z0.3 F1500.0 E15 ; Draw the first line
    G1 X0.4 Y200.0 Z0.3 F5000.0 ; Move to side a little
    G1 X0.4 Y20 Z0.3 F1500.0 E30 ; Draw the second line
    G92 E0 ; Reset Extruder
    G1 Z2.0 F3000 ; Move Z Axis up little to prevent scratching of Heat Bed
    M117 Warpgate activated!
    ; End of custom start GCode

[gcode_macro END_PRINT]
gcode:
    ; Ender 3 Custom End G-code
    G4 ; Wait
    M220 S100 ; Reset Speed factor override percentage to default (100%)
    M221 S100 ; Reset Extrude factor override percentage to default (100%)
    G91 ; Set coordinates to relative
    G1 F1800 E-2 ; Retract filament 2 mm to prevent oozing
    G1 F3000 Z20 ; Move Z Axis up 20 mm to allow filament ooze freely
    G90 ; Set coordinates to absolute
    G1 X0 Y{machine_depth} F1000 ; Move Heat Bed to the front for easy print removal
    M106 S0 ; Turn off cooling fan
    M104 S0 ; Turn off extruder
    M140 S0 ; Turn off bed
    M107 ; Turn off Fan
    M84 ; Disable stepper motors
    M117 Warping complete!
    ; End of custom end GCode

[gcode_macro G29]
default_parameter_BED_MESH_PROFILE_NAME: default
gcode:
    BED_MESH_PROFILE REMOVE={BED_MESH_PROFILE_NAME}
    G28
    BED_MESH_CALIBRATE SAVE={BED_MESH_PROFILE_NAME}
    SAVE_CONFIG

[pause_resume]

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
default_parameter_X: 10    #edit to your park position
default_parameter_Y: 10    #edit to your park position
default_parameter_Z: 10     #edit to your park position
default_parameter_E: 1      #edit to your retract length
gcode:
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-{E} F2100
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F6000

[gcode_macro RESUME]
rename_existing: BASE_RESUME
default_parameter_E: 1      #edit to your retract length
gcode:
    G91
    G1 E{E} F2100
    G90
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    BASE_RESUME

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    TURN_OFF_HEATERS
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    BASE_CANCEL_PRINT
    
[virtual_sdcard]
path: ~/gcode_files

[display_status]